<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Questions - Aqlathon</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600&family=Noto+Sans+Malayalam:wght@300;400;500;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-cyan: #00DCFF;
            --theme-pink: #FF006B;
            --theme-yellow: #FFC61A;
            --theme-violet: #8C3EFF;
            --theme-bg-dark: #140822;
            --theme-card-bg: rgba(31, 18, 53, 0.9);
            --theme-text: #FFFFFF;
        }

        /* RESET & BASIC SETUP */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Noto Sans Malayalam', 'Noto Sans Arabic', sans-serif;
        }

        body {
            min-height: 100vh;
            background-color: var(--theme-bg-dark);
            background-image: linear-gradient(0deg, rgba(0, 220, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 220, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            padding: 20px;
            color: var(--theme-text);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* NAVBAR */
        .navbar {
            background: var(--theme-card-bg);
            padding: 15px 30px;
            border-radius: 15px;
            border: 1px solid rgba(140, 62, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            gap: 15px;
        }

        .navbar h1 {
            font-size: 22px;
            color: var(--theme-cyan);
            font-weight: 600;
        }

        .back-btn {
            text-decoration: none;
            color: white;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 24px;
            border: 1px solid var(--theme-pink);
            border-radius: 50px;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }
        .back-btn:hover { background: var(--theme-pink); box-shadow: 0 0 15px rgba(255, 0, 107, 0.4); }

        /* LAYOUT */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .sidebar-stack {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* CARDS */
        .card {
            background: var(--theme-card-bg);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .card-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card h2 {
            font-size: 18px;
            color: var(--theme-yellow);
            margin: 0;
            line-height: 1.4;
        }

        /* FORM INPUTS */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; color: #ccc; margin-bottom: 8px; font-weight: 500; }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: rgba(0, 0, 0, 0.3);
            color: white;
        }

        .form-control:focus { outline: none; border-color: var(--theme-cyan); background: rgba(0, 0, 0, 0.5); }
        textarea.form-control { resize: vertical; min-height: 100px; }

        /* RADIO BUTTONS */
        .radio-group { display: flex; gap: 20px; padding: 5px 0; flex-wrap: wrap; }
        .radio-label {
            display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #ddd; font-weight: 500;
            padding: 10px 20px; border: 1px solid #444; border-radius: 8px; background: rgba(255, 255, 255, 0.05); transition: all 0.2s;
            flex: 1; min-width: 140px; justify-content: center;
        }
        .radio-label:hover { border-color: var(--theme-cyan); background: rgba(0, 220, 255, 0.1); }
        .radio-label input[type="radio"] { accent-color: var(--theme-cyan); width: 16px; height: 16px; }
        .radio-label:has(input:checked) { border-color: var(--theme-cyan); background: rgba(0, 220, 255, 0.2); color: var(--theme-cyan); }

        /* IMAGE UPLOAD (Main Question) */
        .image-upload-wrapper {
            border: 2px dashed rgba(255, 255, 255, 0.2); padding: 20px; border-radius: 10px; text-align: center;
            background: rgba(0, 0, 0, 0.2); transition: all 0.3s; cursor: pointer; position: relative;
            margin-bottom: 15px;
        }
        .image-upload-wrapper:hover { border-color: var(--theme-cyan); background: rgba(0, 220, 255, 0.05); }
        .image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; display: none; margin-top: 10px; }
        .upload-placeholder { display: flex; flex-direction: column; align-items: center; color: #888; }
        .upload-icon { width: 32px; height: 32px; margin-bottom: 8px; fill: #666; }

        /* Remove Button Style */
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 107, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.2s;
            z-index: 10;
        }
        .remove-btn:hover { background: var(--theme-pink); transform: scale(1.1); }

        /* Existing Images (Edit Mode) */
        .existing-img-wrapper {
            position: relative;
            display: inline-block;
            margin: 5px;
            border: 1px solid var(--theme-cyan);
            border-radius: 8px;
            padding: 2px;
        }
        .existing-img-wrapper img { height: 80px; border-radius: 6px; }

        /* Extra Images Container */
        #extra-images-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* OPTIONS GRID & WRAPPERS */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .option-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.02);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .option-label { font-size: 12px; color: #aaa; font-weight: 600; }

        .opt-img-btn {
            background: transparent; border: none; cursor: pointer; color: #888;
            display: flex; align-items: center; gap: 4px; font-size: 11px;
            transition: color 0.2s;
        }
        .opt-img-btn:hover { color: var(--theme-cyan); }
        .opt-img-btn svg { width: 16px; height: 16px; fill: currentColor; }

        /* Option Preview Container */
        .opt-preview-box {
            position: relative;
            display: none;
            margin-top: 8px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #000;
        }

        .mini-preview {
            width: 100%;
            height: 60px;
            object-fit: contain;
            display: block;
        }

        .opt-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--theme-pink);
            color: white;
            border: 2px solid var(--theme-bg-dark);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
        }

        /* DROPDOWN */
        select.form-control {
            background-color: #1f1235;
        }

        /* BUTTONS */
        .btn-primary {
            background: linear-gradient(90deg, var(--theme-cyan), var(--theme-violet)); 
            color: #140822; width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: transform 0.2s; margin-top: 10px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-primary:hover { transform: translateY(-2px); color: white; box-shadow: 0 0 15px rgba(0, 220, 255, 0.4); }
        .btn-primary:disabled { background: #444; cursor: not-allowed; transform: none; box-shadow: none; color: #888; }

        /* Outline Button (Secondary) */
        .btn-outline {
            background: transparent;
            border: 1px dashed var(--theme-cyan);
            color: var(--theme-cyan);
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 5px;
            text-align: center;
            font-size: 13px;
        }
        .btn-outline:hover {
            background: rgba(0, 220, 255, 0.1);
            border-color: var(--theme-cyan);
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid var(--theme-pink);
            color: var(--theme-pink);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            display: none; /* Hidden by default */
        }
        .btn-cancel:hover { background: rgba(255, 0, 107, 0.1); }

        /* QUESTIONS LIST CONTAINER */
        .questions-container { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }

        /* QUESTION CARD */
        .question-card {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(140, 62, 255, 0.3); border-radius: 12px; padding: 25px;
            position: relative; transition: all 0.3s ease; 
        }
        .question-card:hover { transform: translateY(-3px); border-color: var(--theme-cyan); box-shadow: 0 0 20px rgba(0, 220, 255, 0.1); }

        .q-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px; }
        .badge-mcq { background: rgba(0, 220, 255, 0.15); color: var(--theme-cyan); border: 1px solid var(--theme-cyan); }
        .badge-desc { background: rgba(140, 62, 255, 0.15); color: var(--theme-violet); border: 1px solid var(--theme-violet); }

        .card-actions { position: absolute; top: 25px; right: 25px; display: flex; gap: 15px; }
        .action-btn { cursor: pointer; transition: transform 0.2s; background: none; border: none; padding: 0; }
        .action-btn:hover { transform: scale(1.15); }
        .delete-btn { color: var(--theme-pink); }
        .edit-btn { color: var(--theme-cyan); }

        .q-text { font-size: 16px; font-weight: 600; color: white; margin-bottom: 15px; line-height: 1.5; padding-right: 60px; word-wrap: break-word; }
        .q-options-display { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        .q-option-item { 
            background: rgba(255, 255, 255, 0.05); border: 1px solid #444; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #ccc;
            display: flex; flex-direction: column; gap: 5px; 
        }

        .q-option-img { max-height: 50px; object-fit: contain; border-radius: 4px; border: 1px solid #444; align-self: flex-start; }
        
        .q-answer-box { background: rgba(0, 220, 255, 0.1); border: 1px solid var(--theme-cyan); color: var(--theme-cyan); padding: 10px 15px; border-radius: 8px; font-size: 13px; font-weight: 500; display: inline-block; }
        
        .img-grid-display {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
        }
        .img-grid-display img {
            max-width: 100%;
            height: auto;
        }

        /* TOAST */
        .toast {
            position: fixed; bottom: 20px; right: 20px; background: #1f1235; color: white;
            padding: 12px 24px; border-radius: 8px; font-size: 14px; opacity: 0;
            transition: opacity 0.3s; pointer-events: none; z-index: 1000;
            border: 1px solid var(--theme-cyan);
            max-width: 90%;
            right: 5%;
            left: 5%;
            text-align: center;
        }
        .toast.show { opacity: 1; }
        .toast.error { border-color: var(--theme-pink); }
        
        @media(min-width: 768px) {
            .toast {
                width: auto;
                left: auto;
                right: 20px;
                text-align: left;
            }
        }

        /* RESPONSIVE QUERIES */
        @media (max-width: 900px) {
            .content-grid { grid-template-columns: 1fr; }
            
            /* On tablet/smaller desktops, put sidebar items side-by-side */
            .sidebar-stack {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .sidebar-stack > .card {
                flex: 1;
                min-width: 280px;
            }
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 0; }
            
            .navbar { flex-direction: column; text-align: center; gap: 10px; padding: 15px; }
            
            /* Stack options vertically on mobile */
            .options-grid { grid-template-columns: 1fr; }
            .q-options-display { grid-template-columns: 1fr; }

            /* Sidebar items stack vertically on mobile */
            .sidebar-stack { flex-direction: column; }
            .sidebar-stack > .card { min-width: 100%; }

            /* Fix Question Card Deletion on Mobile */
            .question-card { padding: 20px; display: flex; flex-direction: column; }
            .card-actions { position: relative; top: 0; right: 0; align-self: flex-end; margin-bottom: 10px; order: -1; }
            .q-text { padding-right: 0; }
            
            .card { padding: 20px; }
        }
    </style>
    <script>
        // --- Main Question Image Functions ---
        function previewImage(input) {
            const preview = document.getElementById('preview-img');
            const placeholder = document.getElementById('upload-placeholder');
            const previewBox = document.getElementById('main-preview-box');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewBox.style.display = 'block';
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                // If user cancels file picker, DO NOT clear existing image if editing
                // Only reset if it was a fresh upload
                // Handled in removeQuestionImage
            }
        }

        function removeQuestionImage(event) {
            if(event) event.stopPropagation(); // Prevent click from triggering upload dialog
            
            const input = document.getElementById('q-image');
            input.value = ""; // Clear file input
            
            document.getElementById('preview-img').src = "";
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('main-preview-box').style.display = 'none';
            document.getElementById('upload-placeholder').style.display = 'flex';
            
            // Clear the "edit mode" stored image
            if(window.currentEditState) {
                window.currentEditState.mainImage = ""; 
            }
        }

        // --- Extra Question Images Logic ---
        let extraImageCount = 0;

        function addExtraImageField() {
            extraImageCount++;
            const container = document.getElementById('extra-images-container');
            const divId = `extra-img-div-${extraImageCount}`;
            const inputId = `extra-img-input-${extraImageCount}`;
            const previewId = `extra-img-preview-${extraImageCount}`;
            const placeholderId = `extra-placeholder-${extraImageCount}`;
            const previewBoxId = `extra-preview-box-${extraImageCount}`;

            const html = `
                <div id="${divId}" class="image-upload-wrapper" onclick="document.getElementById('${inputId}').click()">
                    <input type="file" id="${inputId}" class="extra-q-image" hidden accept="image/*" onchange="previewExtraImage(this, '${previewId}', '${placeholderId}', '${previewBoxId}', '${divId}')">
                    
                    <div id="${placeholderId}" class="upload-placeholder">
                        <svg class="upload-icon" viewBox="0 0 24 24">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <span>Click to upload another image</span>
                    </div>
                    
                    <div id="${previewBoxId}" style="display: none; position: relative; width: 100%;">
                        <img id="${previewId}" class="image-preview" alt="Preview" style="display: block; margin: 0 auto;">
                    </div>
                    <button type="button" class="remove-btn" onclick="removeExtraImage(event, '${divId}')" title="Remove">×</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function previewExtraImage(input, previewId, placeholderId, previewBoxId, divId) {
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);
            const previewBox = document.getElementById(previewBoxId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewBox.style.display = 'block';
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeExtraImage(event, divId) {
            if(event) event.stopPropagation();
            const el = document.getElementById(divId);
            el.remove();
        }

        function removeExistingExtraImage(index) {
            if(window.currentEditState && window.currentEditState.extraImages) {
                // Remove the URL from the array
                window.currentEditState.extraImages.splice(index, 1);
                // Re-render the existing images list
                renderExistingExtraImages();
            }
        }

        function renderExistingExtraImages() {
            const container = document.getElementById('existing-extra-images-display');
            if(!window.currentEditState || !window.currentEditState.extraImages || window.currentEditState.extraImages.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="margin-bottom: 10px;"><label style="font-size: 12px; color: #aaa;">Current Extra Images:</label><br>';
            window.currentEditState.extraImages.forEach((url, idx) => {
                html += `
                    <div class="existing-img-wrapper">
                        <img src="${url}">
                        <button type="button" class="remove-btn" style="width: 20px; height: 20px; font-size: 12px; top: -5px; right: -5px;" onclick="removeExistingExtraImage(${idx})">×</button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // --- Option Image Functions ---
        function previewOptionImg(input, previewId, boxId) {
            const preview = document.getElementById(previewId);
            const box = document.getElementById(boxId);
            
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    box.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                // Do not hide if we are in edit mode and there was an image
            }
        }

        function removeOptionImage(key) {
            const input = document.getElementById(`img${key}`);
            const box = document.getElementById(`box${key}`);
            
            input.value = ""; // Clear input
            box.style.display = 'none'; // Hide preview box

            // Clear stored edit image
            if(window.currentEditState && window.currentEditState.optionImages) {
                 window.currentEditState.optionImages[key] = "";
            }
        }

        function toggleQuestionType() {
            const mcqSection = document.getElementById('mcq-section');
            const radioButtons = document.getElementsByName('questionType');
            let selectedValue;
            for (const rb of radioButtons) {
                if (rb.checked) {
                    selectedValue = rb.value;
                    break;
                }
            }
            if (selectedValue === 'mcq') {
                mcqSection.style.display = 'block';
                mcqSection.animate([
                    { opacity: 0, transform: 'translateY(-10px)' },
                    { opacity: 1, transform: 'translateY(0)' }
                ], { duration: 300, easing: 'ease-out' });
            } else {
                mcqSection.style.display = 'none';
            }
        }
    </script>
</head>
<body>

    <div class="container">
        
        <div class="navbar">
            <h1>Add Questions</h1>
            <a href="admin.html" class="back-btn">Back</a>
        </div>

        <div class="content-grid">
            
            <div class="card">
                <div class="card-header">
                    <h2><span id="form-title">Create New Question</span></h2>
                    <button id="cancelEditBtn" class="btn-cancel" onclick="window.cancelEdit()">Cancel Edit</button>
                </div>
                <form id="questionForm">
                    
                    <div class="form-group">
                        <label>Question Type</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="questionType" value="mcq" checked onchange="toggleQuestionType()">
                                Multiple Choice
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="questionType" value="descriptive" onchange="toggleQuestionType()">
                                Descriptive
                            </label>
                        </div>
                    </div>

                    <!-- TIMER FIELD -->
                    <div class="form-group">
                        <label>Time Limit (Seconds) (Optional)</label>
                        <input type="number" id="qTimer" class="form-control" placeholder="Leave empty for no timer" min="5">
                    </div>

                    <div class="form-group">
                        <label>Question Text (Optional if Image is uploaded)</label>
                        <textarea id="questionText" class="form-control" dir="auto" placeholder="Type the question here..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Question Image</label>
                        <div class="image-upload-wrapper" onclick="document.getElementById('q-image').click()">
                            <input type="file" id="q-image" hidden accept="image/*" onchange="previewImage(this)">
                            
                            <div id="upload-placeholder" class="upload-placeholder">
                                <svg class="upload-icon" viewBox="0 0 24 24">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                                <span>Click to upload image</span>
                            </div>
                            
                            <div id="main-preview-box" style="display: none; position: relative; width: 100%;">
                                <img id="preview-img" class="image-preview" alt="Preview" style="display: block; margin: 0 auto;">
                                <button type="button" class="remove-btn" onclick="removeQuestionImage(event)" title="Remove Image">×</button>
                            </div>
                        </div>

                        <!-- Container for showing existing extra images during edit -->
                        <div id="existing-extra-images-display"></div>

                        <div id="extra-images-container"></div>

                        <button type="button" class="btn-outline" onclick="addExtraImageField()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Add Another Image
                        </button>
                    </div>

                    <div id="mcq-section">
                        <div class="form-group">
                            <label>Options & Option Images (Optional)</label>
                            <div class="options-grid">
                                
                                <div class="option-wrapper">
                                    <div class="option-header">
                                        <span class="option-label">Option A</span>
                                        <label class="opt-img-btn">
                                            <input type="file" id="imgA" hidden accept="image/*" onchange="previewOptionImg(this, 'prevA', 'boxA')">
                                            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                            Add Image
                                        </label>
                                    </div>
                                    <input type="text" id="optA" class="form-control" dir="auto" placeholder="Text for A">
                                    <div id="boxA" class="opt-preview-box">
                                        <img id="prevA" class="mini-preview">
                                        <button type="button" class="opt-remove-btn" onclick="removeOptionImage('A')">×</button>
                                    </div>
                                </div>

                                <div class="option-wrapper">
                                    <div class="option-header">
                                        <span class="option-label">Option B</span>
                                        <label class="opt-img-btn">
                                            <input type="file" id="imgB" hidden accept="image/*" onchange="previewOptionImg(this, 'prevB', 'boxB')">
                                            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                            Add Image
                                        </label>
                                    </div>
                                    <input type="text" id="optB" class="form-control" dir="auto" placeholder="Text for B">
                                    <div id="boxB" class="opt-preview-box">
                                        <img id="prevB" class="mini-preview">
                                        <button type="button" class="opt-remove-btn" onclick="removeOptionImage('B')">×</button>
                                    </div>
                                </div>

                                <div class="option-wrapper">
                                    <div class="option-header">
                                        <span class="option-label">Option C</span>
                                        <label class="opt-img-btn">
                                            <input type="file" id="imgC" hidden accept="image/*" onchange="previewOptionImg(this, 'prevC', 'boxC')">
                                            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                            Add Image
                                        </label>
                                    </div>
                                    <input type="text" id="optC" class="form-control" dir="auto" placeholder="Text for C">
                                    <div id="boxC" class="opt-preview-box">
                                        <img id="prevC" class="mini-preview">
                                        <button type="button" class="opt-remove-btn" onclick="removeOptionImage('C')">×</button>
                                    </div>
                                </div>

                                <div class="option-wrapper">
                                    <div class="option-header">
                                        <span class="option-label">Option D</span>
                                        <label class="opt-img-btn">
                                            <input type="file" id="imgD" hidden accept="image/*" onchange="previewOptionImg(this, 'prevD', 'boxD')">
                                            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                            Add Image
                                        </label>
                                    </div>
                                    <input type="text" id="optD" class="form-control" dir="auto" placeholder="Text for D">
                                    <div id="boxD" class="opt-preview-box">
                                        <img id="prevD" class="mini-preview">
                                        <button type="button" class="opt-remove-btn" onclick="removeOptionImage('D')">×</button>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="form-group">
                            <label>Correct Answer</label>
                            <select id="correctAnswer" class="form-control">
                                <option value="" disabled selected>Select the correct option</option>
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="saveQuestionBtn" class="btn-primary">Save Question</button>
                </form>
            </div>

            <div class="sidebar-stack">
                
                <div class="card" style="height: fit-content;">
                    <div class="card-header">
                        <h2>Question Summary</h2>
                    </div>
                    <div style="text-align: center; padding: 20px 0;">
                        <div id="countTotal" style="font-size: 40px; font-weight: 600; color: var(--theme-cyan);">0</div>
                        <div style="font-size: 14px; color: #aaa;">Total Questions Added</div>
                    </div>
                    <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0;">
                    <div style="font-size: 13px; color: #ccc; line-height: 1.6;">
                        <p>• <span id="countMcq" style="color: var(--theme-yellow)">0</span> MCQ Questions</p>
                        <p>• <span id="countDesc" style="color: var(--theme-violet)">0</span> Descriptive Questions</p>
                    </div>
                </div>

                <div class="card" style="height: fit-content;">
                    <div class="card-header">
                        <h2>Schedule</h2>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="startTime" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="endTime" class="form-control">
                    </div>

                    <button id="saveScheduleBtn" class="btn-primary" style="background: transparent; border: 1px solid var(--theme-cyan); color: var(--theme-cyan); margin-top: 5px;">
                        Set Timing
                    </button>
                </div>

            </div>

        </div>

        <div class="card" style="background: transparent; border: none; padding: 0;">
            <div style="background: var(--theme-card-bg); padding: 20px 30px; border-radius: 15px; border: 1px solid rgba(140, 62, 255, 0.3); margin-bottom: 20px;">
                <h2 style="font-size: 18px; color: var(--theme-yellow); margin: 0;">Recently Added Questions</h2>
            </div>
            
            <div id="questionsList" class="questions-container">
                <div style="text-align:center; color:#999; padding:20px;">Loading questions...</div>
            </div>
        </div>

    </div>

    <div id="toast" class="toast">Action Successful</div>

    <script type="module">
        // 1. Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // 2. Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDyOY8tyJeGeiylQdVKBxS3dJrnFBHl39w",
            authDomain: "aqlathon-main.firebaseapp.com",
            projectId: "aqlathon-main",
            storageBucket: "aqlathon-main.firebasestorage.app",
            messagingSenderId: "556012566990",
            appId: "1:556012566990:web:c897e1d2d9ec912dc7939f",
            measurementId: "G-TK0F4M4QES"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const CLOUDINARY_CLOUD_NAME = "dncvypdap";
        const CLOUDINARY_UPLOAD_PRESET = "aqlathon"; 
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        // GLOBAL STATE FOR EDITING
        let isEditing = false;
        let editingId = null;
        window.allQuestionsData = {}; // Cache to store data for editing
        window.currentEditState = null; // Store current urls for images during edit

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast show ${type}`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        async function uploadToCloudinary(file) {
            if (!file) return "";
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            const response = await fetch(CLOUDINARY_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(`Image Upload Failed: ${errData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            return data.secure_url;
        }

        // --- EDIT FUNCTIONS ---
        window.editQuestion = (id) => {
            const data = window.allQuestionsData[id];
            if (!data) return;

            isEditing = true;
            editingId = id;

            // Store existing images in state so we can preserve them if not changed
            window.currentEditState = {
                mainImage: data.imageUrl || "",
                extraImages: data.additionalImages ? [...data.additionalImages] : [],
                optionImages: data.optionImages ? {...data.optionImages} : {A:"", B:"", C:"", D:""}
            };

            // Update UI
            document.getElementById('form-title').textContent = "Edit Question";
            document.getElementById('saveQuestionBtn').textContent = "Update Question";
            document.getElementById('cancelEditBtn').style.display = "block";
            
            // Populate Fields
            document.getElementById('questionText').value = data.text || "";
            document.getElementById('qTimer').value = data.timer || "";
            
            // Set Radio
            const radios = document.getElementsByName('questionType');
            for(const r of radios) {
                if(r.value === data.type) r.checked = true;
            }
            toggleQuestionType();

            // Main Image Preview
            if (data.imageUrl) {
                const prev = document.getElementById('preview-img');
                const box = document.getElementById('main-preview-box');
                const ph = document.getElementById('upload-placeholder');
                prev.src = data.imageUrl;
                prev.style.display = 'block';
                box.style.display = 'block';
                ph.style.display = 'none';
            } else {
                removeQuestionImage(null);
            }

            // Render Existing Extra Images
            renderExistingExtraImages();

            // Populate MCQ fields
            if (data.type === 'mcq') {
                ['A', 'B', 'C', 'D'].forEach(key => {
                    document.getElementById(`opt${key}`).value = data.options[key] || "";
                    
                    // Option Images
                    const imgUrl = data.optionImages ? data.optionImages[key] : "";
                    const prev = document.getElementById(`prev${key}`);
                    const box = document.getElementById(`box${key}`);
                    if (imgUrl) {
                        prev.src = imgUrl;
                        box.style.display = 'block';
                    } else {
                        box.style.display = 'none';
                        prev.src = "";
                    }
                });
                document.getElementById('correctAnswer').value = data.answer || "";
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEdit = () => {
            isEditing = false;
            editingId = null;
            window.currentEditState = null;

            document.getElementById('form-title').textContent = "Create New Question";
            document.getElementById('saveQuestionBtn').textContent = "Save Question";
            document.getElementById('cancelEditBtn').style.display = "none";
            
            document.getElementById('questionForm').reset();
            removeQuestionImage(null);
            document.getElementById('existing-extra-images-display').innerHTML = '';
            document.getElementById('extra-images-container').innerHTML = '';
            ['A', 'B', 'C', 'D'].forEach(key => removeOptionImage(key));
            
            toggleQuestionType();
        };

        // --- SUBMIT HANDLER ---
        const form = document.getElementById('questionForm');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveQuestionBtn');
            
            const text = document.getElementById('questionText').value.trim();
            const qFileInput = document.getElementById('q-image');
            const timerVal = document.getElementById('qTimer').value;

            // In edit mode, we check if text exists OR if there is a preserved image OR a new image
            const hasMainImage = (isEditing && window.currentEditState.mainImage) || qFileInput.files.length > 0;

            if (!text && !hasMainImage) {
                showToast("Please provide either Question Text or a Question Image.", "error");
                return;
            }

            btn.disabled = true;
            btn.textContent = isEditing ? "Updating..." : "Uploading & Saving...";

            try {
                const type = document.querySelector('input[name="questionType"]:checked').value;
                
                // 1. Handle Main Image
                let finalMainImageUrl = "";
                if (qFileInput.files.length > 0) {
                    finalMainImageUrl = await uploadToCloudinary(qFileInput.files[0]);
                } else if (isEditing) {
                    finalMainImageUrl = window.currentEditState.mainImage;
                }

                // 2. Handle Extra Images
                // New uploads
                const extraInputs = document.querySelectorAll('.extra-q-image');
                const extraImagePromises = Array.from(extraInputs).map(input => {
                    if(input.files.length > 0) return uploadToCloudinary(input.files[0]);
                    return Promise.resolve(null);
                });
                const newExtraUrls = (await Promise.all(extraImagePromises)).filter(url => url !== null);
                
                // Combine with existing (if editing)
                let finalExtraUrls = newExtraUrls;
                if (isEditing && window.currentEditState.extraImages) {
                    finalExtraUrls = [...window.currentEditState.extraImages, ...newExtraUrls];
                }

                const questionData = {
                    type: type,
                    text: text,
                    imageUrl: finalMainImageUrl, 
                    additionalImages: finalExtraUrls,
                    timer: timerVal ? parseInt(timerVal) : null,
                    updatedAt: new Date().toISOString()
                };

                // Add createdAt only for new docs
                if (!isEditing) {
                    questionData.createdAt = new Date().toISOString();
                }

                if (type === 'mcq') {
                    questionData.options = {
                        A: document.getElementById('optA').value,
                        B: document.getElementById('optB').value,
                        C: document.getElementById('optC').value,
                        D: document.getElementById('optD').value
                    };
                    
                    // Handle Option Images
                    const finalOptionImages = { A: "", B: "", C: "", D: "" };
                    
                    const keys = ['A', 'B', 'C', 'D'];
                    const uploadPromises = keys.map(async key => {
                        const input = document.getElementById(`img${key}`);
                        if (input.files.length > 0) {
                            return await uploadToCloudinary(input.files[0]);
                        } else if (isEditing && window.currentEditState.optionImages) {
                            return window.currentEditState.optionImages[key];
                        }
                        return "";
                    });

                    const urls = await Promise.all(uploadPromises);
                    keys.forEach((key, index) => {
                        finalOptionImages[key] = urls[index];
                    });

                    questionData.optionImages = finalOptionImages;
                    questionData.answer = document.getElementById('correctAnswer').value;
                    
                    if(!questionData.answer) throw new Error("Please select the correct answer");
                } else {
                    // Cleanup options if switching to Descriptive
                    questionData.options = {};
                    questionData.optionImages = {};
                    questionData.answer = "";
                }

                if (isEditing) {
                    await updateDoc(doc(db, "questions", editingId), questionData);
                    showToast("Question updated successfully!");
                    window.cancelEdit(); // Reset UI
                } else {
                    await addDoc(collection(db, "questions"), questionData);
                    showToast("Question added successfully!");
                    form.reset();
                    removeQuestionImage(null);
                    ['A', 'B', 'C', 'D'].forEach(key => removeOptionImage(key));
                    document.getElementById('extra-images-container').innerHTML = ''; 
                    extraImageCount = 0;
                    document.getElementById('qTimer').value = "";
                    toggleQuestionType();
                }

            } catch (error) {
                console.error("Error saving question:", error);
                showToast(error.message || "Error saving question", "error");
            } finally {
                btn.disabled = false;
                btn.textContent = isEditing ? "Update Question" : "Save Question";
            }
        });

        window.deleteQuestion = async (id) => {
            if(confirm("Are you sure you want to delete this question?")) {
                try {
                    await deleteDoc(doc(db, "questions", id));
                    showToast("Question deleted");
                    // If we deleted the question currently being edited, cancel edit mode
                    if (isEditing && editingId === id) {
                        window.cancelEdit();
                    }
                } catch (error) {
                    showToast("Error deleting question", "error");
                }
            }
        }

        const qContainer = document.getElementById('questionsList');
        const countTotal = document.getElementById('countTotal');
        const countMcq = document.getElementById('countMcq');
        const countDesc = document.getElementById('countDesc');

        const qQuery = query(collection(db, "questions"), orderBy("createdAt", "desc"));

        onSnapshot(qQuery, (snapshot) => {
            qContainer.innerHTML = '';
            
            let total = 0;
            let mcq = 0;
            let desc = 0;

            if (snapshot.empty) {
                qContainer.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">No questions added yet.</div>';
            }

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const id = docSnap.id;
                
                // STORE DATA GLOBALLY FOR EDITING
                window.allQuestionsData[id] = data;
                
                total++;
                if(data.type === 'mcq') mcq++;
                else desc++;

                const badgeClass = data.type === 'mcq' ? 'badge-mcq' : 'badge-desc';
                const typeLabel = data.type === 'mcq' ? 'Multiple Choice' : 'Descriptive';
                const timerDisplay = data.timer ? `<span class="q-badge" style="border: 1px solid #ccc; color: #fff; margin-left: 5px;">⏱ ${data.timer}s</span>` : '';
                
                // Build HTML for images (Main + Extra)
                let allImagesHtml = '';
                
                if (data.imageUrl) {
                    allImagesHtml += `<img src="${data.imageUrl}" style="max-height: 150px; border-radius: 8px; border: 1px solid #444;">`;
                }

                if (data.additionalImages && data.additionalImages.length > 0) {
                    data.additionalImages.forEach(url => {
                         allImagesHtml += `<img src="${url}" style="max-height: 150px; border-radius: 8px; border: 1px solid #444;">`;
                    });
                }
                
                const imageSection = allImagesHtml ? `<div class="img-grid-display">${allImagesHtml}</div>` : '';

                let optionsHtml = '';

                if (data.type === 'mcq') {
                    // Helper to render option item with possible image
                    const renderOpt = (key, text) => {
                        const imgUrl = (data.optionImages && data.optionImages[key]) ? data.optionImages[key] : '';
                        const imgTag = imgUrl ? `<img src="${imgUrl}" class="q-option-img">` : '';
                        return `
                            <div class="q-option-item">
                                <strong>${key})</strong> ${text}
                                ${imgTag}
                            </div>
                        `;
                    };

                    optionsHtml = `
                        <div class="q-options-display">
                            ${renderOpt('A', data.options.A)}
                            ${renderOpt('B', data.options.B)}
                            ${renderOpt('C', data.options.C)}
                            ${renderOpt('D', data.options.D)}
                        </div>
                        <div class="q-answer-box">Correct Answer: Option ${data.answer}</div>
                    `;
                } else {
                    optionsHtml = `
                        <div class="q-answer-box" style="background: rgba(140, 62, 255, 0.1); border-color: var(--theme-violet); color: var(--theme-violet);">
                            Type: Descriptive (Manual Evaluation)
                        </div>
                    `;
                }

                const card = `
                    <div class="question-card">
                        <span class="q-badge ${badgeClass}">${typeLabel}</span>
                        ${timerDisplay}
                        
                        <div class="card-actions">
                            <button class="action-btn edit-btn" title="Edit Question" onclick="window.editQuestion('${id}')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </button>
                            <button class="action-btn delete-btn" title="Delete Question" onclick="deleteQuestion('${id}')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <p class="q-text">${data.text}</p>
                        ${imageSection}
                        ${optionsHtml}
                    </div>
                `;
                qContainer.innerHTML += card;
            });

            countTotal.textContent = total;
            countMcq.textContent = mcq;
            countDesc.textContent = desc;
        });

        const scheduleBtn = document.getElementById('saveScheduleBtn');
        scheduleBtn.addEventListener('click', async () => {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            
            if(!start || !end) {
                showToast("Please select both start and end times", "error");
                return;
            }

            scheduleBtn.textContent = "Saving...";
            try {
                await setDoc(doc(db, "settings", "exam_config"), {
                    startTime: start,
                    endTime: end,
                    updatedAt: new Date().toISOString()
                });
                showToast("Exam schedule updated!");
            } catch(e) {
                console.error(e);
                showToast("Error updating schedule", "error");
            } finally {
                scheduleBtn.textContent = "Set Timing";
            }
        });

        // --- NEW: FETCH AND DISPLAY SAVED SCHEDULE ---
        
        // Reference the settings document
        const configRef = doc(db, "settings", "exam_config");

        // Listen for real-time updates to populate the inputs
        onSnapshot(configRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // If start time exists in DB, set the input value
                if (data.startTime) {
                    document.getElementById('startTime').value = data.startTime;
                }

                // If end time exists in DB, set the input value
                if (data.endTime) {
                    document.getElementById('endTime').value = data.endTime;
                }
            } else {
                console.log("No schedule set yet.");
            }
        });

    </script>
</body>
</html>